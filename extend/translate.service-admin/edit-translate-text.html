<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>编辑翻译</title>
    <link rel="stylesheet" href="./src/css/layui.css">
    <style>
        body {
            padding: 20px;
            box-sizing: border-box;
        }
        .layui-form-label, .translated-label {
            display: block;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: normal;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.5;
            padding: 0;
        }
        .layui-input-block, .translated-text-container {
            width: 100%;
            display: block;
            margin: 0;
        }
        .layui-textarea {
            width: 100%;
            height: 150px;
            resize: vertical;
            font-size: 14px;
            line-height: 1.5;
            border: 1px solid #d2d2d2;
            border-radius: 4px;
            padding: 8px;
            box-sizing: border-box;
            margin: 0;
        }
        .save-button-container {
            text-align: center;
            margin-top: 20px;
        }
        .layui-form-item {
            margin-bottom: 20px;
            padding: 0;
        }
        /* 增强 msg 加载提示文本样式 */
        .layui-layer-content {
            font-size: 18px !important;
            color: #009688 !important;
            font-weight: bold !important;
        }
    </style>
</head>
<body>
<div class="layui-form">
    <div class="layui-form-item">
        <label class="layui-form-label">原文:</label>
        <div class="layui-input-block">
            <textarea class="layui-textarea" readonly id="originalText" style="height: 300px"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="translated-label" id="languageLabel">翻译为 english 的译文:</label>
        <div class="translated-text-container">
            <textarea class="layui-textarea" id="translatedText" style="height: 300px"></textarea>
        </div>
    </div>
    <div class="layui-form-item save-button-container">
        <button class="layui-btn" onclick="saveTranslation()">保存</button>
    </div>
</div>

<script src="./src/layui.js"></script>
<script src="./src/msg.js"></script>
<script src="./translate.service.js"></script>
<script>
    layui.use(['form', 'layer', 'jquery'], function(){
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.jquery;

        // 清理文本，移除异常字符
        function cleanText(str) {
            if (!str || typeof str !== 'string') return '';
            return str.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g, '') // 移除控制字符
                .replace(/['‘’][‘’]\s*[)）]/g, '') // 移除 '‘’ ）' 等异常字符
                .trim();
        }

        // 解析 URL 参数
        function getQueryParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            return r ? decodeURIComponent(r[2]) : '';
        }

        var id = cleanText(getQueryParam('id'));
        var domainParam = cleanText(getQueryParam('domain'));
        var language = cleanText(getQueryParam('language'));
        var text = cleanText(getQueryParam('text'));
        var originalText = cleanText(getQueryParam('originalText'));

        // 调试：输出接收的参数
        console.log('Received params:', { id, domainParam, language, text, originalText });

        // 动态设置语言标签
        if (language) {
            $('#languageLabel').text('翻译为 ' + language + ' 的译文:');
        } else {
            $('#languageLabel').text('翻译为未知语言的译文:');
        }

        // 填充数据
        $('#originalText').val(originalText);
        $('#translatedText').val(text);

        // 保存翻译
        window.saveTranslation = function() {
            var updatedText = $('#translatedText').val().trim();
            if (!updatedText) {
                msg.failure('译文不能为空');
                return;
            }

            // 显示保存中的加载提示
            var loadIndex = msg.loading('正在保存...');

            var params = {
                token: token,
                originalText: originalText,
                to: language,
                resultText: updatedText,
                domain: domainParam
            };

            console.log('Saving params:', params);

            request.post(domain + 'admin/cache/setCacheText.json', params, function(result) {
                // 关闭保存中的加载提示
                msg.close(loadIndex);

                if (result.result === 1) {
                    // 显示更新中的加载提示
                    var updateLoadIndex = msg.loading('保存成功，正在更新数据...');
                    setTimeout(function() {
                        try {
                            window.parent.postMessage({
                                type: 'updateTranslation',
                                id: id,
                                language: language,
                                text: updatedText,
                                frameName: window.name,
                                updateLoadIndex: updateLoadIndex
                            }, '*');
                            console.log('Sent postMessage:', { id, language, text: updatedText, frameName: window.name, updateLoadIndex });
                        } catch (e) {
                            console.error('Failed to send postMessage:', e);
                            msg.close(updateLoadIndex);
                        }
                    }, 2000); // 延迟 2 秒
                } else {
                    msg.failure(result.info || '保存失败');
                }
            });
        };
    });
</script>
</body>
</html>